---
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
---
<style>

.centered-title {
  text-align: center;
  font-weight: bold;
  font-size: 36px;
  margin-bottom: 40px;
}

h1 {
  font-weight: bold;
  font-size: 30px;
}

h2 {
  font-weight: bold;
  font-size: 22px;
}

h3 {
  font-weight: bold;
  font-size: 14px;
}
</style>

<div class="centered-title">Data Cleaning</div>

# Data Source

* **[Student Weight Status](https://health.data.ny.gov/Health/Student-Weight-Status-Category-Reporting-Results-B/es3k-2aus)**: The source is official health.data.ny.gov (NY state government). The data provides information about weight status category data (underweight, healthy weight, overweight or obese) and estimates of the percent of students overweight, obese and overweight or obese for all reportable grades within the county and/or region and by grade groups (elementary and middle/high).

* **[Student Enrolled Demographics Data](https://pad.human.cornell.edu/schools/datadownload.cfm)**: The source is Cornell University's data library. The data provides

```{r message=FALSE, echo=FALSE}
library(tidyverse)
library(readr)
```

# Data Cleaning
## Student Weight Data

What we did: 

* We have focused our investigation on the most recent five academic years, spanning from 2014 to 2019. To maintain consistency, each academic year, which is represented by the later half of the previous year and the earlier half of the next year, is denoted by the next year. For example, the academic year 2014-2015 is denoted as 2015.

* In our analysis, we deliberately excluded summation data, retaining only information from distinct categories. This ensures that our focus is solely on granular data from diverse categories.

* To streamline our dataset for subsequent analyses, we have retained only the informative variables. These variables have been carefully selected based on their quality and relevance to our intended analytical purposes. 

```{r message=FALSE}
Student_Weight = read_csv("data/Student Weight.csv")
```

```{r}
Student_Weight  = 
  Student_Weight |>
  janitor::clean_names() |>
  rename('district'='location_code') |>
  filter(year_reported %in% c("2014-2015", "2015-2016", "2016-2017", "2017-2018", "2018-2019"))
```

```{r}
Student_Weight$year_reported = sub(".*-", "", Student_Weight$year_reported)

Student_Weight = 
  Student_Weight |>
  mutate(year_reported = as.numeric(Student_Weight$year_reported)) |>
  filter(grade_level!="DISTRICT TOTAL" & sex!="ALL" & county!='STATEWIDE (EXCLUDING NYC)') |> 
  select(-region, -area_name)
```

```{r}
show_student_weight = 
  Student_Weight |>
  head(7) |>
  knitr::kable(digits = 3) |>
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) |> 
  kableExtra::scroll_box(width = "100%", height = "300px")

show_student_weight
```


## Demographics Data

What we did: 

* We have adhered to the standardized format of variable names, similar to the conventions followed in the Student_Weight dataset.

* we have diligently converted variables to their appropriate data types.

```{r message=FALSE}
Demographics_all = read_csv("data/Demographics_all.csv")
```

```{r message=FALSE}
Demographics_all = 
  Demographics_all |> 
  janitor::clean_names() |>
  mutate(district = as.numeric(district))
```

```{r message=FALSE}
show_demographics = 
  Demographics_all |>
  head(7) |>
  knitr::kable() |>
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) |> 
  kableExtra::scroll_box(width = "100%", height = "300px")

show_demographics
```


## Join Demographics with Student Weight for Years 2015-2019

What we did: 

* To integrate valuable information from the Student_Weight dataset and the Demographics dataset, we've crafted a function designed to merge these datasets. The merging process is based on matching the district code, ensuring cohesiveness between the datasets for each academic year.

* This integration procedure is applied iteratively across the academic years from 2015 to 2019. The outcomes of each iteration, representing a specific academic year, are combined into a comprehensive dataset. 

* The variables in the combined dataset are selected to retain only high-quality, pertinent data essential for our subsequent analyses.

```{r message=FALSE}
join_demo = function(year) {
  Student_Weight_year = 
  Student_Weight |> 
  filter(year_reported == year)

Demographics_all_year = 
  Demographics_all |>
  filter(year==year)

result_year = merge(Student_Weight_year, Demographics_all_year, by = "district")|>
  select(-num_ell, -year_reported) |>
  drop_na()

return(result_year)
}


```

```{r}
year = c(2015, 2016, 2017, 2018, 2019)
result_list = list(result_2015 = tibble(), result_2016 = tibble(), result_2017 = tibble(), result_2018 = tibble(), result_2019 = tibble())

for (i in 1:length(year)) {
  result_list[[i]] = join_demo(year[i])
}

cleaned = bind_rows(result_list)

cleaned = 
  cleaned |>
  select(district, county, year, sex, grade_level, 
         number_overweight, percent_overweight, number_obese, percent_obese, 
         number_overweight_or_obese, percent_overweight_or_obese, 
         number_healthy_weight, percent_healthy_weight, 
         num_asian, num_black, num_hisp, num_am_ind, num_white, num_female, num_male, num_lep, num_multi, num_swd, num_ecdis, num_free_lunch, num_reduced_lunch)
```

```{r message=FALSE}
show_cleaned_data = 
  cleaned |>
  head(7) |>
  knitr::kable(digits=3) |>
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) |> 
  kableExtra::scroll_box(width = "100%", height = "300px")

show_cleaned_data
```

## Export to .csv for Use

What we did:

*  We saved this refined dataset in a .csv file. 

```{r message=FALSE}
write.csv(cleaned, file = "cleaned_data.csv", row.names = FALSE)
```

Here is the dataset we will use for further analysis: [Cleaned Student Weight and Demographics](cleaned_data.csv)