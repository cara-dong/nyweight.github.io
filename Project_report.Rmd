---
output: 
  html_document:
    toc: true
    toc_float: true
---

<style>

.centered-title {
  text-align: center;
  font-weight: bold;
  font-size: 36px;
  margin-bottom: 40px;
}

h1 {
  font-weight: bold;
  font-size: 30px;
}

h2 {
  font-weight: bold;
  font-size: 22px;
}

h3 {
  font-weight: bold;
  font-size: 14px;
}
</style>

<div class="centered-title">Project Report</div>

# Motivation 

The motivation for our project is to conduct a comprehensive analysis to understand the multifactorial dimensions of New York state student health, specifically relating to obesity and overweight prevalence. Our project will seek to establish correlations between student gender groups, grade levels, demographic variables, and weight status to better understand the impact of social determinants on student health outcomes. Insights gained from this analysis will be instrumental in informing public health interventions, educational policies, and community-based programs to promote healthier lifestyles and address the obesity epidemic in New York state.

# Aim 

Our project will develop a web platform designed for the exploration of intrinsic connections between the weight status of New York state students and their demographic characteristics. A multifaceted correlation analysis will be conducted to comprehensively analyze each demographic variable, including causal inferences, regression analyses, and hypothesis testing. Subsequently, the outcomes will be presented in the form of interactive graphs and tabulated data for enhanced accessibility and clarity. Furthermore, a narrated screencast will provide an intuitive overview of the final product, offering an in-depth understanding of the research findings and their implications.


# Data Source

* **[Student Weight Status](https://health.data.ny.gov/Health/Student-Weight-Status-Category-Reporting-Results-B/es3k-2aus)**: The source is official health.data.ny.gov (NY state government). The data provides information about weight status category data (underweight, healthy weight, overweight or obese) and estimates of the percent of students overweight, obese and overweight or obese for all reportable grades within the county and/or region and by grade groups (elementary and middle/high).

* **[Student Enrolled Demographics Data](https://pad.human.cornell.edu/schools/datadownload.cfm)**: The source is Cornell University's data library. The data provides information on demographic information, especially racial and ethnic information, of elementary and middle/high school students at a school district level, spanning years from 1990s to 2019.

# Data Cleaning
## Student Weight Data

* We focused our investigation on the most recent five academic years, spanning from 2014 to 2019. To maintain consistency, each academic `year`, which is represented by the later half of the previous year and the earlier half of the next year, is denoted by the next year in our cleaned dataset. For example, the academic year 2014-2015 is denoted as 2015.

* We renamed `district` to `location_code` to make this dataset easier to join with the other on common-named column.

* We changed the format of `year_reported` to `year` in numeric to prepare for easier plotting and regression model fitting.

* We excluded the rows with "DISTRICT TOTAL" category for `grade_level`, "ALL" category for `sex`, and "STATEWIDE (EXCLUDING NYC)" category for `county`. This is because stratification on a finer level is better for analysis, and overall data record can be very susceptible to outliers already. We do not want them to confuse the analysis more. This ensures that our focus is solely on granular data from diverse categories.

```{r message=FALSE, echo=FALSE}
library(tidyverse)
library(readr)
library(tidyverse)
library(plotly)
library(broom)
library(boot)
library(modelr)
library(ggpubr)
library(rstatix)
library(patchwork)

Student_Weight = read_csv("data/Student Weight.csv")

Student_Weight  = 
  Student_Weight |>
  janitor::clean_names() |>
  rename('district'='location_code') |>
  filter(year_reported %in% c("2014-2015", "2015-2016", "2016-2017", "2017-2018", "2018-2019"))

Student_Weight$year_reported = sub(".*-", "", Student_Weight$year_reported)

Student_Weight = 
  Student_Weight |>
  mutate(year_reported = as.numeric(Student_Weight$year_reported)) |>
  filter(grade_level!="DISTRICT TOTAL" & sex!="ALL" & county!='STATEWIDE (EXCLUDING NYC)') |> 
  select(-region, -area_name)

show_student_weight = 
  Student_Weight |>
  head(7) |>
  knitr::kable(digits = 3) |>
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) |> 
  kableExtra::scroll_box(width = "100%", height = "300px")

show_student_weight
```


## Demographics Data

* We have adhered to the standardized format of variable names, similar to the conventions followed in the Student_Weight dataset.

* We did not filter on year as before because this dataset spans from year 2015 to year 2019, just like the filtered Student_Weight data.

* We decided to keep all columns at this time because we think it is better to see which columns should be dropped after joining so that we can keep as many information as possible.

* We converted `district` to numeric type for easier joining.

```{r message=FALSE, echo=FALSE}
Demographics_all = read_csv("data/Demographics_all.csv")

Demographics_all = 
  Demographics_all |> 
  janitor::clean_names() |>
  mutate(district = as.numeric(district))

show_demographics = 
  Demographics_all |>
  head(7) |>
  knitr::kable() |>
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) |> 
  kableExtra::scroll_box(width = "100%", height = "300px")

show_demographics
```


## Join Demographics with Student Weight for Years 2015-2019

* To integrate valuable information from the Student_Weight dataset and the Demographics dataset, we've looped through the five years from 2015 to 2019 to merge these two datasets corresponding to each year. The merging process is based on bindings rows regarding with district codes, ensuring cohesiveness between the datasets for each academic year reported.

* We dropped `num_ell` column because it contains null data for most columns.

* We kept only the `num_free_lunch` and `num_reduced_lunch` columns as is for data in years from 2015 to 2017, and replaced the values for these two columns with the median from year 2016 and 2017 for data in years 2018 and 2019. They are replaced just to be consistent with the overall data structure. Analysis regarding lunch types will only be conducted for data in years from 2015 to 2017.

* The variables in the combined dataset are selected to retain only high-quality, pertinent data essential for our subsequent analyses, such as district, county, year, sex, grade_level, number_overweight, percent_overweight, number_obese, percent_obese, number_overweight_or_obese, percent_overweight_or_obese, number_healthy_weight, percent_healthy_weight, num_asian, num_black, num_hisp, num_am_ind, num_white, num_female, num_male, num_lep, num_multi, num_swd, num_ecdis, num_free_lunch, num_reduced_lunch.

```{r message=FALSE, echo=FALSE}
Student_Weight_2015 = 
  Student_Weight |> 
  filter(year_reported==2015)

Demographics_all_2015 = 
  Demographics_all |>
  filter(year==2015)

result_2015 = merge(Student_Weight_2015, Demographics_all_2015, by = "district")|>
  select(-num_ell, -year_reported) |>
  drop_na()

Student_Weight_2016 = 
  Student_Weight |> 
  filter(year_reported==2016)

Demographics_all_2016 = 
  Demographics_all |>
  filter(year==2016)

result_2016 = merge(Student_Weight_2016, Demographics_all_2016, by = "district")|>
  select(-num_ell, -year_reported) |>
  drop_na()

Student_Weight_2017 = 
  Student_Weight |> 
  filter(year_reported==2017)

Demographics_all_2017 = 
  Demographics_all |>
  filter(year==2017)

result_2017 = merge(Student_Weight_2017, Demographics_all_2017, by = "district")|>
  select(-num_ell, -year_reported) |>
  drop_na()

Student_Weight_2018 = 
  Student_Weight |> 
  filter(year_reported==2018)

Demographics_all_2018 = 
  Demographics_all |>
  filter(year==2018)

result_2018 = merge(Student_Weight_2018, Demographics_all_2018, by = "district")|>
  select(-num_ell, -year_reported) |>
  mutate(num_free_lunch = ifelse(is.na(num_free_lunch), median(result_2016$num_free_lunch)), 
         num_reduced_lunch = ifelse(is.na(num_reduced_lunch), median(result_2016$num_reduced_lunch))) |>
  drop_na()

Student_Weight_2019 = 
  Student_Weight |> 
  filter(year_reported==2019)

Demographics_all_2019 = 
  Demographics_all |>
  filter(year==2019)

result_2019 = merge(Student_Weight_2019, Demographics_all_2019, by = "district")|>
  select(-num_ell, -year_reported) |>
  mutate(num_free_lunch = ifelse(is.na(num_free_lunch), median(result_2017$num_free_lunch)), 
         num_reduced_lunch = ifelse(is.na(num_reduced_lunch), median(result_2017$num_reduced_lunch))) |>
  drop_na()

cleaned_data = bind_rows(result_2015, result_2016, result_2017, result_2018, result_2019)

cleaned_data = 
  cleaned_data |>
  select(district, county, year, sex, grade_level, 
         number_overweight, percent_overweight, number_obese, percent_obese, 
         number_overweight_or_obese, percent_overweight_or_obese, 
         number_healthy_weight, percent_healthy_weight, 
         num_asian, num_black, num_hisp, num_am_ind, num_white, num_female, num_male, num_lep, num_multi, num_swd, num_ecdis, num_free_lunch, num_reduced_lunch)

show_cleaned_data = 
  cleaned_data |>
  head(7) |>
  knitr::kable(digits=3) |>
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) |> 
  kableExtra::scroll_box(width = "100%", height = "300px")

show_cleaned_data
```


# Exploratory Analysis

```{r message = FALSE, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(tidyverse)
library(plotly)
library(viridis)
cleaned_data = read_csv("cleaned_data.csv")

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6, 
  out.width = "90%"
)

theme_set (theme_minimal() +theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis", 
  ggplots.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_disrete = scale_fill_viridis_d
```

## 1. State-level overweight percentage changes over years
We want to look at the state-level overweight percentage changes over years to check if there is a change as time goes by, so we employed visualizations to examine the trends in average overweight percentages among New York State students from 2015 to 2019. We do that by calculating the state-level average overweight percent and plot results as a spaghetti plot. Legends are dropped to help visualization. 
```{r message = FALSE, echo = FALSE}
# add up each county's percentage for each year
county_year_data = 
  cleaned_data |>
  group_by (year) |>
  summarize(ave_overweight_percent = mean(percent_overweight)) 

years = unique(sort(county_year_data$year))

plot_ly(county_year_data, x = ~year, y = ~ave_overweight_percent, type = "scatter", mode = "lines+markers") |>
  layout(title = "Average Overweight Percentage Over Time",
       xaxis = list(title = "Year", tickmode = "array", tickvals = years),
         yaxis = list(title = "Average Overweight Percentage"),
         showlegend = FALSE) 
```

The percentage of students classified as overweight in the state of New York remained relatively constant from 2015 to 2019. Despite apparent fluctuations in the depicted data, such as a surge in 2016 and a drop in 2017, these variations can be attributed to the confined range of the y-axis. Specifically, the values fluctuate within a limited span, ranging only between 16.7% and 17.3%.


## 2. County-level percent of overweight/obese/healthy students
```{r message = FALSE, echo = FALSE}
# calculate the average percentage of overweight/obsed/healthy for all years
county_ave_data = 
  cleaned_data |>
  group_by (county) |>
  summarize(ave_overweight_percent = mean(percent_overweight), 
            ave_obese_percent = mean(percent_obese), 
           ave_healthy_percent = mean(percent_healthy_weight)*100) 

county_ave_data = county_ave_data |>
   mutate(county = fct_reorder(county, ave_overweight_percent)) 

plot_ly(county_ave_data, y = ~ave_overweight_percent, x = ~county, type = 'bar', color = ~county) |>
  layout(title = "Percentage Overweight by County",
         xaxis = list(title = "County"),
         yaxis = list(title = "Average Percentage Overweight"),
         showlegend = FALSE,
         xaxis = list(tickangle = -60))

top_overweight = county_ave_data |> arrange(desc(ave_overweight_percent)) |>head(5) |>select(county,ave_overweight_percent) 

knitr::kable(top_overweight, caption = "Three Counties with Highest Overweight Percent") 

county_ave_data = county_ave_data |>
   mutate(county = fct_reorder(county, ave_obese_percent)) 

plot_ly(county_ave_data, x = ~county, y = ~ave_obese_percent, type = 'bar', color = ~county) |>
  layout(title = "Percentage Obese by County",
         xaxis = list(title = "County"),
         yaxis = list(title = "Average Percentage Obese"),
         showlegend = FALSE,
         xaxis = list(tickangle = -60))


top_obese = county_ave_data |> arrange(desc(ave_obese_percent)) |>head(5)|>select(county,ave_obese_percent)

knitr::kable(top_obese, caption = "Three Counties with Highest Obese Percent") 

county_ave_data = county_ave_data |>
   mutate(county = fct_reorder(county, ave_healthy_percent)) 

plot_ly(county_ave_data, x = ~county, y = ~ave_healthy_percent, type = 'bar', color = ~county) |>
  layout(title = "Percentage Healthy by County",
         xaxis = list(title = "County"),
         yaxis = list(title = "Average Percentage Healthy"),
         showlegend = FALSE,
         xaxis = list(tickangle = -60))

top_healthy = county_ave_data |> arrange(desc(ave_healthy_percent)) |> head(5)|>select(county,ave_healthy_percent)

knitr::kable(top_healthy, caption = "Three Counties with Highest Healthy Percent") 
```

This county-level analysis highlighted regions with notably high overweight and obese percentages, pinpointing areas such as Oswego County for potential targeted interventions. It is recommended that educational and health authorities explore counties ranked high in student overweight percentage to glean insights on effectively managing this situation by policy making.

## 3. Change of percent of overweight students in two grade levels
We also want to look at the change of the percent of overweight students in two different grade levels to guide our variable selection process in later regression model fitting step.
```{r message = FALSE, echo = FALSE}
element_middle_data = 
  cleaned_data |>
  group_by (county, grade_level) |>
  filter(grade_level == "ELEMENTARY" | grade_level == "MIDDLE/HIGH") |>
  summarize(ave_overweight_percent = mean(percent_overweight), 
            ave_obese_percent = mean(percent_obese), 
            ave_healthy_percent = mean(percent_healthy_weight)*100) 

grade_level_data = 
  cleaned_data |>
  group_by (grade_level, year) |>
  summarize(ave_overweight_percent = mean(percent_overweight), 
            ave_obese_percent = mean(percent_obese), 
            ave_healthy_percent = mean(percent_healthy_weight)*100)

ggplot(grade_level_data, aes(x = year, y = ave_overweight_percent, color = grade_level)) +
  geom_point() +
  geom_line() +
  labs(title = "Average Overweight Percentage Over Years by Grade Level",
       x = "Year",
       y = "Average Overweight Percentage",
       color = "Grade Level") +
  theme_minimal()
```

Our visual comparisons between elementary and middle school students across counties indicated a general trend of higher overweight percentages among middle school students, which tells us that this variable is a fair choice to be included in our prediction model.

## 4. Change of percent of overweight students in two sex groups
Next, we want to see if sex affects students' overweight percentage for each school district over the five years of data record.
```{r message = FALSE, echo = FALSE}
sex_data = 
  cleaned_data |>
  group_by (sex, year) |>
  summarize(ave_overweight_percent = mean(percent_overweight), 
            ave_obese_percent = mean(percent_obese), 
            ave_healthy_percent = mean(percent_healthy_weight)*100) 

# geom line to compare 
ggplot(sex_data, aes(x = year, y = ave_overweight_percent, color = sex)) +
  geom_point() +
  geom_line() +
  labs(title = "Average Overweight Percentage Over Years by Sex",
       x = "Year",
       y = "Average Overweight Percentage",
       color = "Sex") +
  theme_minimal()
```

The plot indicates that the likelihood of female students having a higher percentage of overweight cases compared to male students is noticeable. This pattern may be influenced by a complex interplay of biological, behavioral, and socio-cultural factors. For instance, hormonal differences between males and females can affect the distribution of muscle and fat in their bodies.

## 5. Student Demographic Information
Lastly, we want to examine the association between the number of five different student racial groups in each district with the average percentage of overweight students in that district. Upon reviewing the cleaned data, there is a hypothesis that various racial groups may exhibit distinct probabilities of experiencing overweight conditions. Therefore, our analysis will commence by examining the distribution of different racial groups among students for each year.

```{r message = FALSE, echo = FALSE}
# the distribution of racial group, first group by district zip code
race_dis_data = cleaned_data |>
  group_by (year, district) |>
  summarize (num_white = mean(num_white), 
             num_asian = mean(num_asian), 
             num_am_ind = mean(num_am_ind), 
             num_black = mean(num_black), 
             num_hisp = mean(num_hisp))

race_year_data = race_dis_data |>
  group_by (year) |>
  summarize(asian = sum(num_asian), 
            white = sum(num_white), 
            american_indian = sum(num_am_ind), 
            black = sum(num_black), 
            hispanic = sum(num_hisp))

race_year_data = pivot_longer(race_year_data, cols = -year, names_to = "race", values_to = "number" )

```

```{r message = FALSE, echo = FALSE}
race_2015 = race_year_data |>
  filter(year == "2015")

plot_2015 = plot_ly(race_2015, labels = ~race, values = ~ number, type = "pie", hole = 0.2, textinfo = 'number', textposition = 'inside', marker = list(colors = c("pink", "orange", "brown", "blue", "green"))) |>
  layout(title = "Distribution of Races in 2015")

race_2016 = race_year_data |>
  filter(year == "2016")

plot_2016 = plot_ly(race_2016, labels = ~race, values = ~ number, type = "pie", hole = 0.2, textinfo = 'number', textposition = 'inside', marker = list(colors = c("pink", "orange", "brown", "blue", "green"))) |>
  layout(title = "Distribution of Races in 2016")

race_2017 = race_year_data |>
  filter(year == "2017")

plot_2017 = plot_ly(race_2017, labels = ~race, values = ~ number, type = "pie", hole = 0.2, textinfo = 'number', textposition = 'inside', marker = list(colors = c("pink", "orange", "brown", "blue", "green"))) |>
  layout(title = "Distribution of Races in 2017")

race_2018 = race_year_data |>
  filter(year == "2018")

plot_2018 = plot_ly(race_2018, labels = ~race, values = ~ number, type = "pie", hole = 0.2, textinfo = 'number', textposition = 'inside', marker = list(colors = c("pink", "orange", "brown", "blue", "green"))) |>
  layout(title = "Distribution of Races in 2018")

race_2019 = race_year_data |>
  filter(year == "2019")

plot_2019 = plot_ly(race_2019, labels = ~race, values = ~ number, type = "pie", hole = 0.2, textinfo = 'number', textposition = 'inside', marker = list(colors = c("pink", "orange", "brown", "blue", "green"))) |>
  layout(title = "Distribution of Races in 2019")

plot_2015
plot_2016
plot_2017
plot_2018
plot_2019
```

The pie charts reveal that approximately 60% of the student population is white, while around 20% identifies as Hispanic. There are smaller proportions of Asian, American Indian, and Black students. 

Following this, we generate scatter plots to visualize the county-level average distribution of racial groups and the corresponding average percentage of overweight individuals to guide out variable selection in linear models.

```{r message = FALSE, echo = FALSE}
county_dis_data = cleaned_data |>
  group_by(year, county, district) |>
  summarize (percent_overweight = mean(percent_overweight), 
             num_white = mean(num_white), 
             num_asian = mean(num_asian), 
             num_am_ind = mean(num_am_ind), 
             num_black = mean(num_black), 
             num_hisp = mean(num_hisp))

county_year_data = county_dis_data |>
  group_by(year, county) |>
  summarize (percent_overweight = mean(percent_overweight), 
             num_white = sum(num_white), 
             num_asian = sum(num_asian), 
             num_am_ind = sum(num_am_ind), 
             num_black = sum(num_black), 
             num_hisp = sum(num_hisp))

county_data = county_year_data |>
  group_by(county) |>
  summarize (percent_overweight = mean(percent_overweight), 
             num_white = mean(num_white), 
             num_asian = mean(num_asian), 
             num_am_ind = mean(num_am_ind), 
             num_black = mean(num_black), 
             num_hisp = mean(num_hisp))

county_data = county_data |>
  mutate(total_students = num_am_ind+num_white+num_asian+num_black+num_hisp, 
         percent_asian = num_asian/total_students*100, 
         percent_white = num_white/total_students*100, 
         percent_hisp = num_hisp /total_students*100, 
         percent_am_ind = num_am_ind/total_students*100, 
         percent_black = num_black/total_students*100)
```

```{r message = FALSE, echo = FALSE}
library(patchwork)
# county level different races number vs. percent overweight scatterplots
plot1 = ggplot(county_data, aes(x = percent_asian, y = percent_overweight)) +
  geom_point() +
  labs(title = "County-Level Percentage Overweight vs. Percent of Each Racial Groups",
       x = "Percent of Asians",
       y = "Percentage Overweight") +
  theme(plot.title = element_text(size = 12),
        axis.title.x = element_text(size = 6),   # Adjust x-axis label size
        axis.title.y = element_text(size = 6))

plot2 = ggplot(county_data, aes(x = percent_white, y = percent_overweight)) +
  geom_point() +
  labs(x = "Percent of White",
       y = "Percentage Overweight")+
  theme(axis.title.x = element_text(size = 6),   # Adjust x-axis label size
        axis.title.y = element_text(size = 6))

plot3 = ggplot(county_data, aes(x = percent_black, y = percent_overweight)) +
  geom_point() +
  labs(x = "Percent of Black",
       y = "Percentage Overweight") +
  theme(axis.title.x = element_text(size = 6),   # Adjust x-axis label size
        axis.title.y = element_text(size = 6))

plot4 = ggplot(county_data, aes(x = percent_am_ind, y = percent_overweight)) +
  geom_point() +
  labs(x = "Percent of American Indian",
       y = "Percentage Overweight") +
  theme(axis.title.x = element_text(size = 6),   # Adjust x-axis label size
        axis.title.y = element_text(size = 6))

plot5 = ggplot(county_data, aes(x = percent_hisp, y = percent_overweight)) +
  geom_point() +
  labs(x = "Percent of hispanic",
       y = "Percentage Overweight") +
  theme(axis.title.x = element_text(size = 6),   # Adjust x-axis label size
        axis.title.y = element_text(size = 6))

combined_plots = plot1+plot2+plot3+plot4+plot5 

combined_plots
```

In the five scatterplots presented above, a noticeable trend emerges where an increase in the percentage of Asian, Black, and Hispanic students is associated with a decrease in the percentage of overweight individuals. Conversely, there appears to be no distinct relationship between the percentage of American Indian students and the percentage overweight. Notably, as the percentage of White students increases, there seems to be an upward trend in the percentage of overweight individuals. This suggests a potential positive correlation between the number of White students and the percentage of overweight individuals. To delve deeper into this relationship, further exploration will be conducted using regression analysis.

# Statistical Analysis

## ---Two-Sample T-Tests

We first ensured that the assumptions for two-sample t-tests are satisfied.
```{r message=FALSE, warning=FALSE, echo=FALSE}
normality_check1 = cleaned_data |>
  filter(sex=="FEMALE") |>
  ggplot(aes(x = number_overweight), theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))) + 
  geom_histogram(alpha = 0.8, color = "white") + 
  labs(
    x = "Number Overweight" ,
    y = "Count",
    title = "Female Number Overweight")

normality_check2 = cleaned_data |>
  filter(sex=="MALE") |>
  ggplot(aes(x = number_overweight), theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))) + 
  geom_histogram(alpha = 0.8, color = "white") + 
  labs(
    x = "Number Overweight" ,
    y = "Count",
    title = "Male Number Overweight")

normality_check3 = cleaned_data |>
  filter(grade_level=="ELEMENTARY") |>
  ggplot(aes(x = number_overweight), theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))) + 
  geom_histogram(alpha = 0.8, color = "white") + 
  labs(
    x = "Number Overweight" ,
    y = "Count",
    title = "Elementary Number Overweight")

normality_check4 = cleaned_data |>
  filter(grade_level=="MIDDLE/HIGH") |>
  ggplot(aes(x = number_overweight), theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))) + 
  geom_histogram(alpha = 0.8, color = "white") + 
  labs(
    x = "Number Overweight" ,
    y = "Count",
    title = "Middle/High Number Overweight")

combined_plot = normality_check1 + normality_check2 + normality_check3 + normality_check4 

combined_plot_layout = combined_plot + 
  plot_layout(ncol = 2, nrow = 2)

combined_plot_layout
```

From the histograms, we see that the number of overweight students in four groups are all right-skewed, so we need to perform a log transformation before testing. Here are the distributions after transformation.

```{r message=FALSE, warning=FALSE, echo=FALSE}
t_test_data = cleaned_data |>
  mutate(log_number_overweight = log(number_overweight + 1))

normality_check1 = t_test_data |>
  filter(sex=="FEMALE") |>
  ggplot(aes(x = log_number_overweight), theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))) + 
  geom_histogram(alpha = 0.8, color = "white") + 
  labs(
    x = "Log Number Overweight" ,
    y = "Count",
    title = "Log Female Number Overweight")

normality_check2 = t_test_data |>
  filter(sex=="MALE") |>
  ggplot(aes(x = log_number_overweight), theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))) + 
  geom_histogram(alpha = 0.8, color = "white") + 
  labs(
    x = "Log Number Overweight" ,
    y = "Count",
    title = "Log Male Number Overweight")

normality_check3 = t_test_data |>
  filter(grade_level=="ELEMENTARY") |>
  ggplot(aes(x = log_number_overweight), theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))) + 
  geom_histogram(alpha = 0.8, color = "white") + 
  labs(
    x = "Log Number Overweight" ,
    y = "Count",
    title = "Log Elementary Number Overweight")

normality_check4 = t_test_data |>
  filter(grade_level=="MIDDLE/HIGH") |>
  ggplot(aes(x = log_number_overweight), theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))) + 
  geom_histogram(alpha = 0.8, color = "white") + 
  labs(
    x = "Log Number Overweight" ,
    y = "Count",
    title = "Log Middle/High Number Overweight")

combined_plot = normality_check1 + normality_check2 + normality_check3 + normality_check4 

combined_plot_layout = combined_plot + 
  plot_layout(ncol = 2, nrow = 2)

combined_plot_layout
```

Now, the distributions look roughly normal.

Next, we check for equality of variance.

Test for Equality of Variances by Sex
```{r message=FALSE, warning=FALSE, echo=FALSE}
t_test_data |> 
  levene_test(log_number_overweight ~ sex) |>
  knitr::kable(title = "Test for Equality of Variances by Sex")
```


Test for Equality of Variances by Grade Level
```{r message=FALSE, warning=FALSE, echo=FALSE}
t_test_data |> 
  levene_test(log_number_overweight ~ grade_level) |> 
  knitr::kable(title="Test for Equality of Variances by Grade Level")
```

Since the p-values for both are not significant, we will use independent t-test with equal variance.

### 1. Female Students Across Grade Levels
```{r message=FALSE, warning=FALSE, echo=FALSE}
female_data = t_test_data[t_test_data$sex == 'FEMALE', ]

elementary_data = female_data[female_data$grade_level == 'ELEMENTARY', 'log_number_overweight']
middle_high_data = female_data[female_data$grade_level == 'MIDDLE/HIGH', 'log_number_overweight']

t_test_result = t.test(elementary_data, middle_high_data, var.equal = TRUE)

print(t_test_result)
```

The two-sample t-test revealed a statistically significant difference in the mean log number of overweight female students between elementary and middle/high schools. Elementary schools exhibited a higher mean, suggesting a greater prevalence of overweight conditions among younger female students.

### 2. Male Students Across Grade Levels
```{r message = FALSE, warning=FALSE, echo=FALSE}
male_data = t_test_data[t_test_data$sex == 'MALE', ]

elementary_data = male_data[male_data$grade_level == 'ELEMENTARY', 'log_number_overweight']
middle_high_data = male_data[male_data$grade_level == 'MIDDLE/HIGH', 'log_number_overweight']

t_test_result = t.test(elementary_data, middle_high_data, var.equal = TRUE)

print(t_test_result)
```

A similar pattern was observed in male students. The t-test showed a significant difference between elementary and middle/high school male students, with higher mean log numbers of overweight students in elementary schools.

### 3. Elementary Students Across Sex Groups
```{r message = FALSE, warning=FALSE, echo=FALSE}
elementary = t_test_data[t_test_data$grade_level == 'ELEMENTARY', ]

male = elementary[elementary$sex == 'MALE', 'log_number_overweight']
female = elementary[elementary$sex == 'FEMALE', 'log_number_overweight']

t_test_result = t.test(male, female, var.equal = TRUE)

print(t_test_result)
```
In elementary schools, the t-test indicated no significant difference in the mean log number of overweight students between male and female groups, suggesting similar overweight prevalence across genders at this educational level.

### 4. Middle/High School Students Across Sex Groups
```{r message = FALSE, warning=FALSE, echo=FALSE}
middle_high = t_test_data[t_test_data$grade_level == 'MIDDLE/HIGH', ]

male = middle_high[middle_high$sex == 'MALE', 'log_number_overweight']
female = middle_high[middle_high$sex == 'FEMALE', 'log_number_overweight']

t_test_result = t.test(male, female, var.equal = TRUE)

print(t_test_result)
```
For middle/high school students, the t-test also found no significant difference in overweight prevalence between male and female students, highlighting comparable conditions across genders in older student groups.


## ---Regression Analyses

First, we checked the distribution of the one of the two outcomes we are concerned about.
```{r message=FALSE, warning=FALSE, echo=FALSE}
train_data  = 
  cleaned_data |>
  select(year, sex, grade_level, 
         number_overweight, percent_overweight,
         number_obese, percent_obese, 
         number_overweight_or_obese, percent_overweight_or_obese,
         number_healthy_weight, percent_healthy_weight) |>
  mutate(sex = ifelse(sex=="FEMALE", 0, 1), 
         grade_level = ifelse(grade_level=="ELEMENTARY", 0, 1)) |>
  drop_na()

school_level_dist = train_data |>
  ggplot(aes(x = percent_overweight)) + 
  geom_histogram(alpha = 0.8, color = "white") + 
  labs(
    x = "Percent Overweight" ,
    y = "Count",
    title = "Distribution of Percent Overweight at Finer School Level")

ggplotly(school_level_dist)
```

The distribution is roughly normal, so no transformation is needed.

Next, we will plot the distribution for the median percent of overweight students at district level to accommodate the granularity of student demographic information.
```{r message=FALSE, warning=FALSE, echo=FALSE}
selected = 
  cleaned_data |>
  select(year, district, percent_overweight, num_asian, num_black, num_hisp, num_am_ind, num_white)

district_level_data = 
  selected |>
  group_by(year, district) |>
  summarise(med_overweight = median(percent_overweight)) |>
  drop_na()

group_demo = 
  selected |>
  group_by(year, district) |>
  summarise(total_asian = max(num_asian), 
            total_black = max(num_black),
            total_hisp = max(num_hisp), 
            total_am_ind = max(num_am_ind), 
            total_white = max(num_white)) |>
  drop_na()

result_df = 
  district_level_data |> 
  left_join(group_demo, by = c("year", "district")) |>
  ungroup() |>
  select(-district)

overweight_dist = result_df |>
  ggplot(aes(x = med_overweight)) + 
  geom_histogram(alpha = 0.8, color = "white") + 
  labs(
    x = "Median Percent of Overweight" ,
    y = "Count",
    title = "Distribution of Median Percent of Overweight")

ggplotly(overweight_dist)
```

The distribution is roughly normal, so no transformation is needed.

### 1. SLR - Sex vs Percentage of Overweight
```{r message=FALSE, warning=FALSE, echo=FALSE}
sex_slr = lm(percent_overweight ~ sex, data = train_data) 
sex_slr_df = sex_slr |> broom::tidy()

knitr::kable(sex_slr_df)
```

The SLR model we fit is percent_overweight at school-level = 17.546446 - 1.177219 * sex.

The coefficient estimate of -1.177219 with a p-value of almost 0 indicates that the effect of sex on the percentage of overweight students is statistically significant.

Since female is encoded as the reference group 0, we can say that male students group in NY schools had lower percentage of overweight students compared to female students group. This corresponds to the line plot visualization displayed in the previous section, where the line for male students is always below that for female students.

### 2. SLR - Grade Level vs Percent of Overweight
```{r message=FALSE, warning=FALSE, echo=FALSE}
grade_level_slr = lm(percent_overweight ~ grade_level, data = train_data)
grade_level_slr_df = grade_level_slr |> broom::tidy()

knitr::kable(grade_level_slr_df)
```

The SLR model we fit is percent_overweight at school-level = 16.126602 - 1.716477	 * grade_level.

The coefficient estimate of 1.716477 with a p-value of almost 0 indicates that the effect of grade_level on the percentage of overweight students is statistically significant.

Since elementary school is encoded as the reference group 0, we can say that middle/high school students in NY had higher percentage of overweight students compared to elementary school students. This also corresponds to the line plot visualization displayed in the previous section, where the line for elementary students is always below that for middle/high school students. This finding suggests that older students are more prone to overweight conditions.

### 3. MLR - Grade Level & Sex vs Percent of Overweight
```{r message=FALSE, warning=FALSE, echo=FALSE}
mlr = lm(percent_overweight ~ grade_level + sex, data = train_data) 

mlr_df = mlr |> broom::tidy()

knitr::kable(mlr_df)
```

The MLR model we fit is percent_overweight at school-level = 16.717571 - -1.179560	 * grade_level + 1.718086 * grade_level.

The coefficient estimates with p-values of almost 0 indicates that the effect of both sex and grade_level on the percentage of overweight students are statistically significant.

Combining sex and grade level in an MLR model, both factors were shown to significantly influence the percentage of overweight students. This model provided a more comprehensive understanding than the individual SLR analyses.

### 4. MLR - Student Demographic Info vs Percent of Overweight

After checking that there is no highly correlated pairs in the predictors, we fit a model that analyzed the relationship between student demographics and overweight percentages at the district level.
```{r message=FALSE, warning=FALSE, echo=FALSE}
mlr = lm(med_overweight ~ ., data = result_df)
display = mlr |> broom::tidy() |> knitr::kable()

display
```

The model we fit is:
Median Percent of Overweight at District Level = 209.229 - 0.0928606 * year - 0.0014845 * total_asian + 0.0001223 * total_black + 0.0002993 * total_hisp + 0.0037642 * total_am_ind - 0.0003124 * total_white. 

Except for the p-value for total_black and year, the coefficients for all other variables are significant. Among them, the total number of American Indian in that school district has the largest absolute value of coefficient. So, holding all other variables constant, with one person increase in the ethnic group of American Indians, there is a 0.0037642 percent increase in the median percent of overweight students at district level.

The regression analysis indicates that demographic factors, specifically the racial composition of students, have a statistically significant association with the median percentage of overweight students at the district level, as evidenced by the p-values for certain racial groups. 

However, the magnitude of these associations, as reflected by the estimated coefficients, is relatively small. It is important to note that while these effects are statistically significant for some racial groups, the small size of the coefficients suggests that the practical significance of these demographic variables on the median percentage of overweight students might be limited.

### 5. MLR - Other Weight Status vs Percent of Overweight
```{r message=FALSE, warning=FALSE, echo=FALSE}
train_data = 
  train_data |> 
  select(year, percent_overweight, percent_obese, percent_overweight_or_obese, percent_healthy_weight)

mlr_weight = lm(percent_overweight ~ ., data = train_data)
display_weight = mlr_weight |> broom::tidy() |> knitr::kable(digits=3)

display_weight
```

Holding all other variables constant, with one percent increase in healthy weight students, there is a 0.039 percent increase in overweight students. However, this is not very significant as the p-value (0.262) for the coefficient is greater than 0.05 at an 95% confidence level.

The analysis of the relationship between different weight statuses and the percentage of overweight students showed a very small and statistically insignificant effect of the percentage of healthy weight students on the percentage of overweight students. This points to the complexity of factors influencing overweight prevalence.

### 6. MLR - Lunch Type vs Percent of Overweight
```{r message=FALSE, warning=FALSE, echo=FALSE}
lunch = 
  cleaned_data |> 
  filter(year %in% c(2015, 2016, 2017)) |>
  group_by(year, district) |>
  summarise(total_num_free_lunch = max(num_free_lunch), 
            total_num_reduced_lunch = max(num_reduced_lunch))

lunch_df = 
  district_level_data |> 
  left_join(lunch, by = c("year", "district")) |>
  ungroup() |>
  select(-district)

mlr = lm(med_overweight ~ ., data = lunch_df)
display = mlr |> broom::tidy() |> knitr::kable()

display
```

The model examined the association between types of lunch and overweight percentages suggested a potential relationship.

The model we fit is: Median Percent of Overweight at District Level = 294.4593529 - 0.1377206	* year + 0.0000718 * total_num_free_lunch + 0.0001812	* total_num_reduced_lunch. 

We might be able to say that having more free lunch and reduced lunch both are associated with increase in the median percent of overweight students at school-district level.

However, none of the predictors included in the model show a statistically significant relationship with the median percentage of overweight students at the school-district level, as all p-values are above the conventional threshold for significance (0.05). These findings indicates the need for further investigation into how nutritional factors contribute to student weight status.

# Discussion

The comprehensive analysis of student health data in New York State has yielded several key insights into the factors influencing the prevalence of overweight and obesity among students. These insights are critical for shaping effective public health strategies and educational interventions.

## 1. Impact of Biological & Academic Factors

Our findings highlight the significant role of biological factors such as sex and academic factors such as grade level in influencing overweight and obesity rates among students. We found that female, middle school students are more susceptible to overweight issue, which aligns with what we expected to some extent. Adolescent students undergo a period of rapid growth, that is very much reflected in females, affecting the biological factors in their bodies even more. The distinct patterns observed across different grade levels and between male and female students underscore the need for targeted health initiatives that are sensitive to these nuances.

## 2. Role of Socio-Cultural Factors

The association between racial composition and overweight percentages, although statistically significant, revealed small effect sizes. This suggests that while racial and socio-cultural factors play a role in student health outcomes, their practical impact might be limited. This is quite surprising to us because we initially assumed that demographic information would be one of the most impactful factors for student weight status other than diet. This calls for a deeper exploration into the complex interplay of socio-cultural dynamics and health behaviors.

## 3. Limitations and Future Research Directions

It is important to note the limitations inherent in our study, particularly the observational nature of the data which restricts our ability to draw causal inferences. Future research, possibly incorporating longitudinal studies and experimental designs, could provide more definitive insights into the causal factors influencing student health. Besides, if more data related to school lunches, family diets, and food price could become available to us, we would be able to incorporate more influential factors into the analysis and make a better prediction.

## 4. Implications for Policy and Practice

The study's findings have important implications for public health policies and school-based health programs. Tailoring interventions to address the specific needs of different student groups, particularly considering age and gender, could be more effective in mitigating overweight and obesity issues. Additionally, integrating an understanding of socio-cultural influences into health promotion strategies could enhance their effectiveness and inclusivenss.

## 5. Comprehensive Approach to Student Health

Ultimately, our analysis points to the necessity of a multifaceted approach in addressing the overweight and obesity epidemic among students. This approach should combine public health interventions, educational policies, and community-based programs, all tailored to the unique needs and backgrounds of the student population. Preventing the development student overweight status is a task that involves efforts from a variety of departments.