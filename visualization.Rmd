---
title: "Data Visualization"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r message = FALSE, echo = FALSE}
library(tidyverse)
library(plotly)
library(viridis)
cleaned_data = read_csv("cleaned_data.csv")

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6, 
  out.width = "90%"
)

theme_set (theme_minimal() +theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis", 
  ggplots.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_disrete = scale_fill_viridis_d
```


## Overweight Percentage Changes Over Year
```{r message = FALSE, echo = FALSE}
# add up each county's percentage for each year
county_year_data = 
  cleaned_data |>
  group_by (county, year) |>
  summarize(ave_overweight_percent = mean(percent_overweight)) 

ggplot(county_year_data, aes(x = year, y = ave_overweight_percent, group = county, color = county )) + 
  geom_line() + 
  geom_point() +
  labs(title = "Average Overweight Percentage Over Time",
       x = "Year",
       y = "Average Overweight Percentage") +
  theme_minimal() +
  theme(legend.position = "none")
  
```
<br>
The current visualization appears messy, making it challenging to see a clear trend. To enhance the clarity of the trend, a new plot depicting the average overweight percentage across counties over time has been created. 
```{r message = FALSE, echo = FALSE}
# add up each county's percentage for each year
county_year_data = 
  cleaned_data |>
  group_by (year) |>
  summarize(ave_overweight_percent = mean(percent_overweight)) 

plot_ly(county_year_data, x = ~year, y = ~ave_overweight_percent, type = "scatter", mode = "lines+markers") |>
  layout(title = "Average Overweight Percentage Over Time",
       xaxis = list(title = "Year"),
         yaxis = list(title = "Average Overweight Percentage"),
         showlegend = FALSE) 
```
By analyzing two plots, it can be concluded that students' overweight percent in New York Stats is generally stable between year 2015 and year 2019; the number fluctuates between 16.7 and 17.3. 

## County-level percent overweight/obese/healthy
```{r message = FALSE, echo = FALSE}
# calculate the average percentage of overweight/obsed/healthy for all years
county_ave_data = 
  cleaned_data |>
  group_by (county) |>
  summarize(ave_overweight_percent = mean(percent_overweight), 
            ave_obese_percent = mean(percent_obese), 
           ave_healthy_percent = mean(percent_healthy_weight)*100) 

county_ave_data = county_ave_data |>
  arrange(ave_overweight_percent)

plot_ly(county_ave_data, y = ~ave_overweight_percent, x = ~county, type = 'bar', color = ~county) |>
  layout(title = "Percentage Overweight by County",
         xaxis = list(title = "County"),
         yaxis = list(title = "Average Percentage Overweight"),
         showlegend = FALSE,
         xaxis = list(tickangle = -60))

top_overweight = county_ave_data |> arrange(desc(ave_overweight_percent)) |>head(5) |>select(county,ave_overweight_percent) 

knitr::kable(top_overweight, caption = "Three Counties with Highest Overweight Percent") 

plot_ly(county_ave_data, x = ~county, y = ~ave_obese_percent, type = 'bar', color = ~county) |>
  layout(title = "Percentage Obese by County",
         xaxis = list(title = "County"),
         yaxis = list(title = "Average Percentage Obese"),
         showlegend = FALSE,
         xaxis = list(tickangle = -60))


top_obese = county_ave_data |> arrange(desc(ave_obese_percent)) |>head(5)|>select(county,ave_obese_percent)

knitr::kable(top_obese, caption = "Three Counties with Highest Obese Percent") 

plot_ly(county_ave_data, x = ~county, y = ~ave_healthy_percent, type = 'bar', color = ~county) |>
  layout(title = "Percentage Healthy by County",
         xaxis = list(title = "County"),
         yaxis = list(title = "Average Percentage Healthy"),
         showlegend = FALSE,
         xaxis = list(tickangle = -60))

top_healthy = county_ave_data |> arrange(desc(ave_healthy_percent)) |> head(5)|>select(county,ave_healthy_percent)

knitr::kable(top_healthy, caption = "Three Counties with Highest Healthy Percent") 
```
Analyzing the plots and tables reveals that Oswego ranks among the top 5 counties with the highest percentages of overweight and obese populations. Consequently, it is recommended that educational and health authorities explore counties with lower indices to glean insights on effectively managing this situation.

## Elementary & Middle school overweight across county
```{r message = FALSE, echo = FALSE}
element_middle_data = 
  cleaned_data |>
  group_by (county, grade_level) |>
  filter(grade_level == "ELEMENTARY" | grade_level == "MIDDLE/HIGH") |>
  summarize(ave_overweight_percent = mean(percent_overweight), 
            ave_obese_percent = mean(percent_obese), 
            ave_healthy_percent = mean(percent_healthy_weight)*100) 
```

```{r message = FALSE, echo = FALSE}
# display and compare elementary and middle/high overweight data  
ggplot(element_middle_data, aes(x = county, y = ave_overweight_percent, fill = grade_level)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Overweight Percentage by County and Grade Level",
       x = "County",
       y = "Overweight Percentage",
       fill = "Grade Level") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
Observing this plot reveals that, in the majority of counties, elementary school students exhibit a lower percentage of overweight compared to their middle school counterparts. As a suggestion, it is recommended to first adjust the school lunch menu to incorporate healthier options, possibly including more fiber. Additionally, middle school students should ensure sufficient exercise by dedicating more time or classes to physical education.

Average Overweight Percent by Grade Level over year
```{r message = FALSE, echo = FALSE}
grade_level_data = 
  cleaned_data |>
  group_by (grade_level, year) |>
  summarize(ave_overweight_percent = mean(percent_overweight), 
            ave_obese_percent = mean(percent_obese), 
            ave_healthy_percent = mean(percent_healthy_weight)*100)
```

```{r message = FALSE, echo = FALSE}
ggplot(grade_level_data, aes(x = year, y = ave_overweight_percent, color = grade_level)) +
  geom_point() +
  geom_line() +
  labs(title = "Average Overweight Percentage Over Years by Grade Level",
       x = "Year",
       y = "Average Overweight Percentage",
       color = "Grade Level") +
  theme_minimal()
```

## sex and overweight
```{r message = FALSE, echo = FALSE}
sex_data = 
  cleaned_data |>
  group_by (sex, year) |>
  summarize(ave_overweight_percent = mean(percent_overweight), 
            ave_obese_percent = mean(percent_obese), 
            ave_healthy_percent = mean(percent_healthy_weight)*100) 
```

```{r message = FALSE, echo = FALSE}
# geom line to compare 
ggplot(sex_data, aes(x = year, y = ave_overweight_percent, color = sex)) +
  geom_point() +
  geom_line() +
  labs(title = "Average Overweight Percentage Over Years by Sex",
       x = "Year",
       y = "Average Overweight Percentage",
       color = "Sex") +
  theme_minimal()
```

## racial group and overweight
```{r message = FALSE, echo = FALSE}
# the distribution of racial group, first group by district zip code
race_dis_data = cleaned_data |>
  group_by (year, district) |>
  summarize (num_white = mean(num_white), 
             num_asian = mean(num_asian), 
             num_am_ind = mean(num_am_ind), 
             num_black = mean(num_black), 
             num_hisp = mean(num_hisp))

race_year_data = race_dis_data |>
  group_by (year) |>
  summarize(asian = sum(num_asian), 
            white = sum(num_white), 
            am_ind = sum(num_am_ind), 
            black = sum(num_black), 
            hisp = sum(num_hisp))

race_year_data = pivot_longer(race_year_data, cols = -year, names_to = "race", values_to = "number" )

```

```{r message = FALSE, echo = FALSE}
race_2015 = race_year_data |>
  filter(year == "2015")

plot_2015 <- plot_ly(race_2015, labels = ~race, values = ~ number, type = "pie", hole = 0.2, textinfo = 'number', textposition = 'inside', marker = list(colors = c("pink", "orange", "brown", "blue", "green"))) |>
  layout(title = "Distribution of Races in 2015")

race_2016 = race_year_data |>
  filter(year == "2016")

plot_2016 = plot_ly(race_2016, labels = ~race, values = ~ number, type = "pie", hole = 0.2, textinfo = 'number', textposition = 'inside', marker = list(colors = c("pink", "orange", "brown", "blue", "green"))) |>
  layout(title = "Distribution of Races in 2016")

race_2017 = race_year_data |>
  filter(year == "2017")

plot_2017 = plot_ly(race_2017, labels = ~race, values = ~ number, type = "pie", hole = 0.2, textinfo = 'number', textposition = 'inside', marker = list(colors = c("pink", "orange", "brown", "blue", "green"))) |>
  layout(title = "Distribution of Races in 2017")

race_2018 = race_year_data |>
  filter(year == "2018")

plot_2018 = plot_ly(race_2018, labels = ~race, values = ~ number, type = "pie", hole = 0.2, textinfo = 'number', textposition = 'inside', marker = list(colors = c("pink", "orange", "brown", "blue", "green"))) |>
  layout(title = "Distribution of Races in 2018")

race_2019 = race_year_data |>
  filter(year == "2019")

plot_2019 = plot_ly(race_2019, labels = ~race, values = ~ number, type = "pie", hole = 0.2, textinfo = 'number', textposition = 'inside', marker = list(colors = c("pink", "orange", "brown", "blue", "green"))) |>
  layout(title = "Distribution of Races in 2019")

plot_2015
plot_2016
plot_2017
plot_2018
plot_2019
```

county level racial group and county level overweight
```{r message = FALSE, echo = FALSE}
county_dis_data = cleaned_data |>
  group_by(year, county, district) |>
  summarize (percent_overweight = mean(percent_overweight), 
             num_white = mean(num_white), 
             num_asian = mean(num_asian), 
             num_am_ind = mean(num_am_ind), 
             num_black = mean(num_black), 
             num_hisp = mean(num_hisp))

county_year_data = county_dis_data |>
  group_by(year, county) |>
  summarize (percent_overweight = mean(percent_overweight), 
             num_white = sum(num_white), 
             num_asian = sum(num_asian), 
             num_am_ind = sum(num_am_ind), 
             num_black = sum(num_black), 
             num_hisp = sum(num_hisp))

county_data = county_year_data |>
  group_by(county) |>
  summarize (percent_overweight = mean(percent_overweight), 
             num_white = mean(num_white), 
             num_asian = mean(num_asian), 
             num_am_ind = mean(num_am_ind), 
             num_black = mean(num_black), 
             num_hisp = mean(num_hisp))

county_data = county_data |>
  mutate(total_students = num_am_ind+num_white+num_asian+num_black+num_hisp, 
         percent_asian = num_asian/total_students*100, 
         percent_white = num_white/total_students*100, 
         percent_hisp = num_hisp /total_students*100, 
         percent_am_ind = num_am_ind/total_students*100, 
         percent_black = num_black/total_students*100)
```


```{r eval = FALSE, message = FALSE, echo = FALSE}
ggplot(county_data, aes(x = county)) +
  geom_bar(aes(y = percent_asian, fill = "Asian"), stat = "identity", position = "stack") +
  geom_bar(aes(y = percent_white, fill = "White"), stat = "identity", position = "stack") +
  geom_bar(aes(y = percent_black, fill = "Black"), stat = "identity", position = "stack") +
  geom_bar(aes(y = percent_am_ind, fill = "Indian"), stat = "identity", position = "stack") +
  geom_bar(aes(y = percent_hisp, fill = "Hispanic"), stat = "identity", position = "stack") +
  geom_line(aes(y = percent_overweight/20, color = "Overweight"), size = 1.5, group = 1) +
  labs(title = "Racial Distribution and Percentage Overweight of Students by County",
       x = "County",
       y = "Percentage of Students",
       fill = "Race") +
  scale_fill_manual(values = c("Asian" = "pink", "White" = "blue", "Black" = "green", "Hispanic" = "purple", "Indian" = "orange")) +
  scale_y_continuous(name = "Percent of different racial students",
                     sec.axis = sec_axis(~.*20, name = "Percentage Overweight")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 80, hjust = 1))


```
interpretation


```{r message = FALSE, echo = FALSE}
# the plotly version of the previous plot
plot_ly(county_data) |>
  add_trace(type = "bar", x = ~county, y = ~percent_asian, name = "Asian", color = "pink") |>
  add_trace(type = "bar", x = ~county, y = ~percent_white, name = "White", color = "blue") |>
  add_trace(type = "bar", x = ~county, y = ~percent_black, name = "Black", color = "green") |>
  add_trace(type = "bar", x = ~county, y = ~percent_am_ind, name = "Indian",color = "orange") |>
  add_trace(type = "bar", x = ~county, y = ~percent_hisp, name = "Hispanic",color = "purple") |>
  add_trace(type = "scatter", x = ~county, y = ~percent_overweight*5, mode = "lines", name = "Overweight", line = list(color = "red", width = 3)) |>
  layout(title = "Racial Distribution and Percentage Overweight of Students by County",
         xaxis = list(title = "County"),
         yaxis = list(title = "Percentage of Students", side = "left"),
         yaxis2 = list(title = "Percentage Overweight", side = "right", overlaying = "y", zeroline = FALSE),
         barmode = "stack",
         showlegend = TRUE)

```


```{r message = FALSE, echo = FALSE}
library(patchwork)
# county level different races number vs. percent overweight scatterplots
plot1 = ggplot(county_data, aes(x = percent_asian, y = percent_overweight)) +
  geom_point() +
  labs(title = "County-Level Percentage Overweight vs. Percent of Each Racial Groups",
       x = "Percent of Asians",
       y = "Percentage Overweight") +
  theme(plot.title = element_text(size = 12),
        axis.title.x = element_text(size = 6),   # Adjust x-axis label size
        axis.title.y = element_text(size = 6))

plot2 = ggplot(county_data, aes(x = percent_white, y = percent_overweight)) +
  geom_point() +
  labs(x = "Percent of White",
       y = "Percentage Overweight")+
  theme(axis.title.x = element_text(size = 6),   # Adjust x-axis label size
        axis.title.y = element_text(size = 6))

plot3 = ggplot(county_data, aes(x = percent_black, y = percent_overweight)) +
  geom_point() +
  labs(x = "Percent of Black",
       y = "Percentage Overweight") +
  theme(axis.title.x = element_text(size = 6),   # Adjust x-axis label size
        axis.title.y = element_text(size = 6))

plot4 = ggplot(county_data, aes(x = percent_am_ind, y = percent_overweight)) +
  geom_point() +
  labs(x = "Percent of American Indian",
       y = "Percentage Overweight") +
  theme(axis.title.x = element_text(size = 6),   # Adjust x-axis label size
        axis.title.y = element_text(size = 6))

plot5 = ggplot(county_data, aes(x = percent_hisp, y = percent_overweight)) +
  geom_point() +
  labs(x = "Percent of hispanic",
       y = "Percentage Overweight") +
  theme(axis.title.x = element_text(size = 6),   # Adjust x-axis label size
        axis.title.y = element_text(size = 6))

combined_plots = plot1+plot2+plot3+plot4+plot5 

combined_plots
```


